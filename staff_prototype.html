<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>Mines of MIDIa</title>
    <!-- midi.js css -->
    <link href="includes/css/MIDIPlayer.css" rel="stylesheet" type="text/css"/>
    <!-- shim -->
    <!--<script src="includes/shim/Base64.js" type="text/javascript"></script>-->
    <script src="includes/shim/Base64binary.js" type="text/javascript"></script>
    <script src="includes/shim/WebAudioAPI.js" type="text/javascript"></script>
    <script src="includes/shim/WebMIDIAPI.js" type="text/javascript"></script>
    <!-- jasmid package -->
    <script src="includes/jasmid/stream.js"></script>
    <script src="includes/jasmid/midifile.js"></script>
    <script src="includes/jasmid/replayer.js"></script>
    <!-- midi.js package -->
    <script src="includes/midi-js/js/midi/audioDetect.js" type="text/javascript"></script>
    <script src="includes/midi-js/js/midi/gm.js" type="text/javascript"></script>
    <script src="includes/midi-js/js/midi/loader.js" type="text/javascript"></script>
    <script src="includes/midi-js/js/midi/plugin.audiotag.js" type="text/javascript"></script>
    <script src="includes/midi-js/js/midi/plugin.webaudio.js" type="text/javascript"></script>
    <script src="includes/midi-js/js/midi/plugin.webmidi.js" type="text/javascript"></script>
    <script src="includes/midi-js/js/midi/player.js" type="text/javascript"></script>
    <!-- utils -->
    <script src="includes/midi-js/js/util/dom_request_xhr.js" type="text/javascript"></script>
    <!--<script src="includes/midi-js/js/util/dom_request_script.js" type="text/javascript"></script>-->
    <!-- includes -->
    <script src="includes/js/timer.js" type="text/javascript"></script>
    <script src="includes/js/event.js" type="text/javascript"></script>
</head>
<body>
<h1>Mines of MIDIa</h1>

<div style="position: fixed; top: 0; left: 0; z-index: 4; overflow: hidden;" id="colors"></div>
<div style="margin-bottom: 50px; border: 1px solid #000; background: rgba(255,255,255,0.5); border-radius: 11px; float: left; width: 800px; padding-bottom: 15px; position: relative; z-index: 2;">
    <div class="player"
         style="height: 42px; box-shadow: 0 -1px #000; margin-bottom: 0; border-bottom-right-radius: 0; border-bottom-left-radius: 0;">
        <div style="margin: 0 auto; width: 160px; float: right;">
            <input type="image" src="includes/images/pause.png" align="absmiddle" value="pause"
                   onclick="pausePlayStop()" id="pausePlayStop">
            <input type="image" src="includes/images/stop.png" align="absmiddle" value="stop"
                   onclick="pausePlayStop(true)">
            <input type="image" src="includes/images/backward.png" align="absmiddle" value="stop"
                   onclick="player.getNextSong(-1);">
            <input type="image" src="includes/images/forward.png" align="absmiddle" value="stop"
                   onclick="player.getNextSong(+1);">
        </div>
        <div class="time-controls" style="float: left; margin: 0; position: relative; top: 5px;">
            <span id="time1" class="time">0:00</span>
            <span id="capsule">
					<span id="cursor"></span>
				</span>
            <span id="time2" class="time" style="text-align: left;">-0:00</span>
        </div>
    </div>
    <div id="title"
         style="background: rgba(255,255,0,0.5); position: relative;color: #000; z-index: -1;padding: 5px 11px 5px;">
        Loading MIDI interface...
    </div>
    <p>This page is just for testing and figuring out MIDI.js and trying to prototype
        the music staff feature.</p>
</div>

<script type="text/javascript">
    // TODO: Populate these songs programmatically with user input
    var songId = 0;
    var songs = ["MyHero.mid", "SweetHomeAlabama.mid"];
    var player;

    if (typeof (console) === "undefined") var console = {
        log: function () {
        }
    };
    // Toggle between Pause and Play modes.
    var pausePlayStop = function (stop) {
        var d = document.getElementById("pausePlayStop");
        if (stop) {
            MIDI.Player.stop();
            d.src = "includes/images/play.png";
        } else if (MIDI.Player.playing) {
            d.src = "includes/images/play.png";
            MIDI.Player.pause(true);
        } else {
            d.src = "includes/images/pause.png";
            MIDI.Player.resume();
        }
    };

    //noinspection JSUnusedLocalSymbols
    eventjs.add(window, "load", function (event) {
        /// TODO: Replace the piano keys with an SVG drum kit.
        var colors = document.getElementById("colors");
        var colorElements = [];
        for (var n = 0; n < 88; n++) {
            var d = document.createElement("div");
            d.innerHTML = MIDI.noteToKey[n + 21];
            colorElements.push(d);
            colors.appendChild(d);
        }

        /// Show a loading image while everything is loading up
        MIDI.loader = new sketch.ui.Timer;

        /// Load the MIDI plugin to play music
        MIDI.loadPlugin({
            soundfontUrl: "includes/soundfonts/",
            instrument: "synth_drum",
            onprogress: function (state, progress) {
                // update the MIDI loader progress graphic as it loads
                MIDI.loader.setValue(progress * 100);
            },
            onsuccess: function () {
                player = MIDI.Player;
                player.timeWarp = 1; // speed the song is played back
                player.loadFile("midi_files/" + songs[songId], onSuccessfulSongLoad);

                /// control the piano keys colors
                player.addListener(function (data) {
                    var pianoKey = data.note - 21;
                    var d = colorElements[pianoKey];
                    if (d) {
                        if (data.message === 144) {
//                            console.log(data);
                            d.style.background = '#f00';
                            d.style.color = "#fff";
                        } else {
                            d.style.background = "";
                            d.style.color = "";
                        }
                    }
                });

                /// Show the player progress bar
                MIDIPlayerPercentage(player);
            }
        });
    });

    var onSuccessfulSongLoad = function(onsuccess) {
        // Show song filename
        var title = document.getElementById("title");
        title.innerHTML = songs[songId];

        // Default drum track is 9
        var drumTrack = 9;

        // Log all meta data
        for (var i = 0; i < player.data.length; i++) {
            var obj = player.data[i][0];
            if (obj.event.type == "meta") {
                console.log(obj.event.subtype + ": " + ((obj.event.text) ? obj.event.text : ""));
                console.log(obj);
                if (obj.event.subtype == "trackName" && obj.event.text && obj.event.text.toLowerCase() == "drums") {
//                    drumTrack = obj.track;
                    console.log("DRUM TRACK: " + drumTrack);
                }
            }
        }

        // Add MIDI drums
        MIDI.programChange(drumTrack, MIDI.GM.byName["synth_drum"].number);

        // Start the player
        player.start(onsuccess);
    };

    var MIDIPlayerPercentage = function (player) {
        // update the timestamp
        var time1 = document.getElementById("time1");
        var time2 = document.getElementById("time2");
        var capsule = document.getElementById("capsule");
        var timeCursor = document.getElementById("cursor");

        // Adjust the play location when the user click-drags in the song progress bar.
        eventjs.add(capsule, "drag", function (event, self) {
            eventjs.cancel(event);
            player.currentTime = (self.x) / 420 * player.endTime;
            if (player.currentTime < 0) player.currentTime = 0;
            if (player.currentTime > player.endTime) player.currentTime = player.endTime;
            if (self.state === "down") {
                player.pause(true);
            } else if (self.state === "up") {
                player.resume();
            }
        });

        function timeFormatting(n) {
            var minutes = n / 60 >> 0;
            var seconds = String(n - (minutes * 60) >> 0);
            if (seconds.length == 1) seconds = "0" + seconds;
            return minutes + ":" + seconds;
        }

        player.getNextSong = function (n) {
            var id = Math.abs((songId += n) % songs.length);
            player.loadFile("midi_files/" + songs[id], onSuccessfulSongLoad);
        };

        //noinspection JSUnusedLocalSymbols
        player.setAnimation(function (data, element) {
            var percent = data.now / data.end;
            var now = data.now >> 0; // where we are now
            var end = data.end >> 0; // end of song
            if (now === end) { // go to next song
                var id = ++songId % songs.length;
                player.loadFile("midi_files/" + songs[id], player.start); // load MIDI
            }
            // display the information to the user
            timeCursor.style.width = (percent * 100) + "%";
            time1.innerHTML = timeFormatting(now);
            time2.innerHTML = "-" + timeFormatting(end - now);
        });
    };
</script>
</body>
</html>
