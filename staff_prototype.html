<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>MIDI.js - Sequencing in Javascript.</title>
    <!-- midi.js css -->
    <link href="includes/midi-js/MIDI.js-master/examples/css/MIDIPlayer.css" rel="stylesheet" type="text/css"/>
    <!-- shim -->
    <!--<script src="includes/shim/Base64.js" type="text/javascript"></script>-->
    <script src="includes/shim/Base64binary.js" type="text/javascript"></script>
    <script src="includes/shim/WebAudioAPI.js" type="text/javascript"></script>
    <script src="includes/shim/WebMIDIAPI.js" type="text/javascript"></script>
    <!-- jasmid package -->
    <script src="includes/jasmid/stream.js"></script>
    <script src="includes/jasmid/midifile.js"></script>
    <script src="includes/jasmid/replayer.js"></script>
    <!-- midi.js package -->
    <script src="includes/midi-js/MIDI.js-master/js/midi/audioDetect.js" type="text/javascript"></script>
    <script src="includes/midi-js/MIDI.js-master/js/midi/gm.js" type="text/javascript"></script>
    <script src="includes/midi-js/MIDI.js-master/js/midi/loader.js" type="text/javascript"></script>
    <script src="includes/midi-js/MIDI.js-master/js/midi/plugin.audiotag.js" type="text/javascript"></script>
    <script src="includes/midi-js/MIDI.js-master/js/midi/plugin.webaudio.js" type="text/javascript"></script>
    <script src="includes/midi-js/MIDI.js-master/js/midi/plugin.webmidi.js" type="text/javascript"></script>
    <script src="includes/midi-js/MIDI.js-master/js/midi/player.js" type="text/javascript"></script>
    <!--<script src="includes/midi-js/MIDI.js-master/js/midi/synesthesia.js" type="text/javascript"></script>-->
    <!-- utils -->
    <script src="includes/midi-js/MIDI.js-master/js/util/dom_request_xhr.js" type="text/javascript"></script>
    <!--<script src="includes/midi-js/MIDI.js-master/js/util/dom_request_script.js" type="text/javascript"></script>-->
    <!-- includes -->
    <script src="includes/midi-js/MIDI.js-master/examples/inc/timer.js" type="text/javascript"></script>
    <script src="includes/midi-js/MIDI.js-master/examples/inc/event.js" type="text/javascript"></script>
</head>
<body>
<h1>MIDI.js - Sequencing in Javascript.</h1>

<div style="position: fixed; top: 0; left: 0; z-index: 4; overflow: hidden;" id="colors"></div>
<div style="margin-bottom: 50px; border: 1px solid #000; background: rgba(255,255,255,0.5); border-radius: 11px; float: left; width: 800px; padding-bottom: 15px; position: relative; z-index: 2;">
    <div class="player"
         style="height: 42px; box-shadow: 0 -1px #000; margin-bottom: 0; border-bottom-right-radius: 0; border-bottom-left-radius: 0;">
        <div style="margin: 0 auto; width: 160px; float: right;">
            <input type="image" src="includes/images/pause.png" align="absmiddle" value="pause"
                   onclick="pausePlayStop()" id="pausePlayStop">
            <input type="image" src="includes/images/stop.png" align="absmiddle" value="stop"
                   onclick="pausePlayStop(true)">
            <input type="image" src="includes/images/backward.png" align="absmiddle" value="stop"
                   onclick="player.getNextSong(-1);">
            <input type="image" src="includes/images/forward.png" align="absmiddle" value="stop"
                   onclick="player.getNextSong(+1);">
        </div>
        <div class="time-controls" style="float: left; margin: 0; position: relative; top: 5px;">
            <span id="time1" class="time">0:00</span>
            <span id="capsule">
					<span id="cursor"></span>
				</span>
            <span id="time2" class="time" style="text-align: left;">-0:00</span>
        </div>
    </div>
    <div id="title"
         style="background: rgba(255,255,0,0.5); position: relative;color: #000; z-index: -1;padding: 5px 11px 5px;">
        Loading API...
    </div>
    <h3 style="margin: 0">What&rsquo;s all this hubub?</h3>
    <p><b><a href="https://github.com/mudcube/MIDI.js">MIDI.js</a></b> ties together, and builds upon frameworks that
        bring MIDI to the browser. Combine it with <a href="https://github.com/gasman/jasmid">jasmid</a> to create a
        web-radio MIDI stream similar to this demo, or with <a href="https://github.com/mrdoob/three.js/">Three.js</a>,
        <a href="https://github.com/zz85/sparks.js/">Sparks.js</a>, or <a href="http://glslsandbox.com">GLSL</a> to
        create Audio/visual experiments. Piano/guitar
        simulations, Drum machines, MIDI recording, and all kinds of certified funkitude is within your grasps!
    <p><a href="https://www.google.com/chrome">Google Chrome</a> is recommended for best listening experience, it&rsquo;s
        timing perfection! Firefox and Safari can both perform a bit more like the piano has been drinking, arrr.</p>
</div>

<script type="text/javascript">
    if (typeof (console) === "undefined") var console = {
        log: function () {
        }
    };
    // Toggle between Pause and Play modes.
    var pausePlayStop = function (stop) {
        var d = document.getElementById("pausePlayStop");
        if (stop) {
            MIDI.Player.stop();
            d.src = "includes/images/play.png";
        } else if (MIDI.Player.playing) {
            d.src = "includes/images/play.png";
            MIDI.Player.pause(true);
        } else {
            d.src = "includes/images/pause.png";
            MIDI.Player.resume();
        }
    };

    //noinspection JSUnusedLocalSymbols
    eventjs.add(window, "load", function (event) {
        /// load up the piano keys
        var colors = document.getElementById("colors");
        var colorElements = [];
        for (var n = 0; n < 88; n++) {
            var d = document.createElement("div");
            d.innerHTML = MIDI.noteToKey[n + 21];
            colorElements.push(d);
            colors.appendChild(d);
        }
        ///
        MIDI.loader = new sketch.ui.Timer;
        MIDI.loadPlugin({
            soundfontUrl: "includes/midi-js/MIDI.js-master/examples/soundfont/",
            instruments: ["synth_drum","synth_drum","synth_drum","synth_drum","synth_drum","synth_drum","synth_drum","synth_drum","synth_drum"],
            onprogress: function (state, progress) {
                MIDI.loader.setValue(progress * 100);
            },
            onsuccess: function () {
                /// this is the language we are running in
                var title = document.getElementById("title");
                title.innerHTML = "Sound being generated with " + MIDI.api + " " + JSON.stringify(MIDI.supports);

                /// this sets up the MIDI.Player and gets things going...
                player = MIDI.Player;
                player.timeWarp = 1; // speed the song is played back
                player.loadFile("midi_files/MyHero.mid", function(onsuccess) {
//                    player.getFileInstruments();
                    MIDI.programChange(9, 9);
//                    MIDI.programChange(9, MIDI.GM.byName["synth_drum"].number);
                    player.start(onsuccess);
                });

                /// control the piano keys colors
                player.addListener(function (data) {
                    var pianoKey = data.note - 21;
                    var d = colorElements[pianoKey];
                    if (d) {
                        if (data.message === 144) {
                            console.log(data);
                            d.style.background = '#f00';
                            d.style.color = "#fff";
                        } else {
                            d.style.background = "";
                            d.style.color = "";
                        }
                    }
                });
                ///
                MIDIPlayerPercentage(player);
            }
        });
        console.log(MIDI.GM.byName);
    });

    var MIDIPlayerPercentage = function (player) {
        // update the timestamp
        var time1 = document.getElementById("time1");
        var time2 = document.getElementById("time2");
        var capsule = document.getElementById("capsule");
        var timeCursor = document.getElementById("cursor");

        // Adjust the play location when the user click-drags in the song progress bar.
        eventjs.add(capsule, "drag", function (event, self) {
            eventjs.cancel(event);
            player.currentTime = (self.x) / 420 * player.endTime;
            if (player.currentTime < 0) player.currentTime = 0;
            if (player.currentTime > player.endTime) player.currentTime = player.endTime;
            if (self.state === "down") {
                player.pause(true);
            } else if (self.state === "up") {
                player.resume();
            }
        });

        function timeFormatting(n) {
            var minutes = n / 60 >> 0;
            var seconds = String(n - (minutes * 60) >> 0);
            if (seconds.length == 1) seconds = "0" + seconds;
            return minutes + ":" + seconds;
        }

        player.getNextSong = function (n) {
            var id = Math.abs((songid += n) % song.length);
            player.loadFile(song[id], player.start); // load MIDI
        };

        //noinspection JSUnusedLocalSymbols
        player.setAnimation(function (data, element) {
            var percent = data.now / data.end;
            var now = data.now >> 0; // where we are now
            var end = data.end >> 0; // end of song
            if (now === end) { // go to next song
                var id = ++songid % song.length;
                player.loadFile(song[id], player.start); // load MIDI
            }
            // display the information to the user
            timeCursor.style.width = (percent * 100) + "%";
            time1.innerHTML = timeFormatting(now);
            time2.innerHTML = "-" + timeFormatting(end - now);
        });
    };


    // Begin loading indication.
    var player;
    // MIDI files from Disklavier World
    var songid = 0;
    var song = [
        // Test 1
        'data:audio/mid;base64,TVRoZAAAAAYAAQABAMBNVHJrAAAARwD/WAQEAhgIAP9RAwehIAD/AwlOZXcgVHJhY2sAwHMAkDxkMoA8MIEOkDxkMoA8MIEOkDxkMoA8MIEOkDxkgT+APDAB/y8A',
//         Test 2
        'data:audio/mid;base64,TVRoZAAAAAYAAQABAMBNVHJrAAAAVwD/WAQEAhgIAP9RAwehIAD/AwlOZXcgVHJhY2sAwAAAkDxkgRCAPDAwkDxkgRCAPDAwkDxkAJBAZACQQ2SBEIA8MACAQDAAgEMwMJA8ZIE/gDwwJv8vAA==',
        // Test 3
        'data:audio/mid;base64,TVRoZAAAAAYAAQABAMBNVHJrAAAAXwD/WAQEAhgIAP9RAwehIAD/AwlOZXcgVHJhY2sAwAAAkDxkgRCAPDAwkDxkgRCAPDAwkDxkAJBAZACQQ2QHkEhkgQmAPDAAgEAwAIBDMACASDAwkDxkgT+APDAm/y8A'
    ];
</script>
</body>
</html>
